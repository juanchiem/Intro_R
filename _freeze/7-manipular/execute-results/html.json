{
  "hash": "3d6583ab95acd71d58ea1b80db127f6f",
  "result": {
    "markdown": "\n\n\n# Manipulación\n\nCheatsheets https://github.com/rstudio/cheatsheets\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-2_47d2526db592debd59653eadd333f3c3'}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-3_b108c237d6bbc759ba27131608a35ffa'}\n\n```{.r .cell-code}\nconflicted::conflict_prefer(\"filter\", \"dplyr\")\nconflicted::conflict_prefer(\"select\", \"dplyr\")\n```\n:::\n\nImportemos **bce_met**\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-4_e62255c3f2d30ffed9804675b46623d0'}\n\n```{.r .cell-code}\nbce_met_raw <- rio::import(\"data/datos_curso.xls\", sheet =\"bce_met\")\n# bce_met_raw\nbce_met_raw\n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-5_bff19c9234087aba3421884f9e781c55'}\n\n```{.r .cell-code}\nglimpse(bce_met_raw)\n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-6_b1dadb7539354c46d43bbe64a9a8ec4a'}\n\n```{.r .cell-code}\nlibrary(skimr)\nskim(bce_met_raw)\n```\n:::\n\n\n## [{dplyr}](https://nyu-cdsc.github.io/learningr/assets/data-transformation.pdf)\n\n### mutate()\n\n-   Crear nueva columna en base a otras pre-existentes\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-7_09ba8c43842e051d5c7fe5fe5b4cb102'}\n\n```{.r .cell-code}\nbce_met <- bce_met_raw %>% \n  mutate(tmean = (tmax + tmin) / 2)\nbce_met\n```\n:::\n\n\nFecha esta como tipo caracter: no nos permitirá usarla como una variable temporal aun...\n\nModificar variables (en este caso el tipo de dato)\n\n[{lubridate}](https://github.com/rstudio/cheatsheets/blob/main/lubridate.pdf) \n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-8_db796ea3ea3de9f0df96191109feaf65'}\n\n```{.r .cell-code}\n# library(lubridate)\nbce_met <- bce_met %>%  \n  mutate(fecha = dmy(fecha)) #paso de character a fecha!\nbce_met\n```\n:::\n\n\nExtraer información de columnas pre-existentes\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-9_b5ada108471d1638b71958f3dbc627fe'}\n\n```{.r .cell-code}\nbce_met <- bce_met %>% \n  mutate(mes = month(fecha), \n         juliano = yday(fecha)) # note que acepta mas de una operacion por mutate()\nbce_met\n```\n:::\n\n\nCrear una columna en base a condiciones simples\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-10_fef312394a8c8a82069fda161e48276b'}\n\n```{.r .cell-code}\nbce_met <- bce_met %>% \n  mutate(helada_meteo = tmin<=0)\nbce_met\n#16\n```\n:::\n\n\nCrear varias columnas en base a condiciones\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-11_c21eb98817c9ab19b8d114a79e79421f'}\n\n```{.r .cell-code}\nbce_met <- bce_met %>% \n  mutate(\n    helada_meteo = tmin<=0,\n    helada_agro = between(tmin, 0,3),\n    )\nbce_met\n```\n:::\n\n\n#### case_when\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-12_aef3944714c0de148d2fcf8b860cc518'}\n\n```{.r .cell-code}\nbce_met <- bce_met %>% \n  mutate(\n    ambiente = case_when(\n      tmean < 10  ~ \"fresco\", \n      tmean >= 10 & tmean <= 20  ~ \"templado\",\n      tmean > 20  ~ \"calido\")\n  )\nbce_met\n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-13_276ff792eebab310de5b38834dbf3794'}\n\n```{.r .cell-code}\nbce_met <- bce_met %>% \n  mutate(\n    ambiente = case_when(\n      tmean < 10  ~ \"fresco\", \n      tmean > 20  ~ \"calido\", \n      TRUE ~ \"templado\")\n  )\nbce_met\n```\n:::\n\n\n#### group_by()\n\nOperaciones por sub-grupos\n\n- if_else\n- cumsum\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-14_c7c433a21ca74abd5cd349db3b341b63'}\n\n```{.r .cell-code}\nbce_met <- bce_met %>% \n  mutate(\n    grados_efectivos = if_else(tmean>10, tmean-10, 0),\n    suma_termica = cumsum(grados_efectivos)\n  )\n# suma_termica = cumsum(ifelse(date>=\"2018-10-01\", grados_efectivos, 0)))\nbce_met\n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-15_ac330193e4427df4cd4e05de7f98028e'}\n\n```{.r .cell-code}\nbce_met <- bce_met %>% \n  group_by(mes) %>% \n  mutate(\n    # grados_efectivos = ifelse(tmean>10, tmean-10, 0),\n    suma_termica_mes = cumsum(grados_efectivos)\n  ) %>% \n  ungroup()\n# suma_termica = cumsum(ifelse(date>=\"2018-10-01\", grados_efectivos, 0)))\nbce_met\n#hoja4\n```\n:::\n\n\n### select()\n\nSelecciona columnas basadas en sus nombres\n\n> Descartemos las tmin, tmax y las sumas termicas y reubiquemos las variables de fechas en primer lugar\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-16_fb25b2f8e74e99a41beaae10ecc63ae4'}\n\n```{.r .cell-code}\nbce_met\nbce_met1 <- bce_met %>%  \n  select(fecha, mes, juliano, tmedia=tmean, rad, helada_meteo, helada_agro, ambiente)\nbce_met1\n```\n:::\n\n\nOpción 2: descartar variables\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-17_284eac5e74e1d9cda7e315e7fb378281'}\n\n```{.r .cell-code}\nbce_met1 <- bce_met %>% \n  select(-tmin, -tmax, -grados_efectivos, -suma_termica, -suma_termica_mes)\nbce_met1\n```\n:::\n\n\nOpción 3: seleccionar, renombrar y acomodar\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-18_6e7d18379e8249a86edbd0840be207b6'}\n\n```{.r .cell-code}\nbce_met1 <- bce_met %>% \n  select(fecha, mes, juliano, tmedia=tmean, rad, contains(\"helada\"), ambiente) # cuanto mas eficiente estamos siendo\nbce_met1\n```\n:::\n\n\n:::\n\n### filter()\n\nFiltra filas en base a condiciones\n\n> Filtrar por: dias tuvieron heladas meteorológicas\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-19_651e77e3e70f86ea1e0305f518c63ef1'}\n\n```{.r .cell-code}\nbce_met1 %>% \n  filter(helada_meteo==TRUE) \n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-20_ad7bd51172d1aca1209029a4f884dee0'}\n\n```{.r .cell-code}\nbce_met1 %>% \n  filter(tmedia<10)\n```\n:::\n\n\n::: callout-note\n### Otras condiciones\n\nFiltrar por: condicion multiplicativa\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-21_b25c8917a5c2b843bc7d2ee1d5706f48'}\n\n```{.r .cell-code}\nbce_met1 %>% \n  filter(tmedia<10 & rad>10)\n```\n:::\n\n\nFiltrar por: condición aditiva\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-22_01341494546e7bb56f6ce0de3086465f'}\n\n```{.r .cell-code}\nbce_met1 %>% \n  filter(tmedia<10 | rad>10)\n```\n:::\n\n\nfiltrar por la negativa de la condicion\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-23_388348413a7b96990f649a51c1445829'}\n\n```{.r .cell-code}\nbce_met1 %>% \n  filter(!(tmedia<10 | rad>10))\n# 300+65\n```\n:::\n\n\nfiltrar por rango\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-24_148b197f4923e1cc5598ccc56c04526d'}\n\n```{.r .cell-code}\nbce_met1 %>% \n  filter(between(tmedia,3,6))\n```\n:::\n\n:::\n\n### count()\n\nCuenta el numero de observaciones por grupo\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-25_ba5ff5d9d8ca270bd3e40b9d38f128a3'}\n\n```{.r .cell-code}\nbce_met1 %>% \n  count(helada_meteo)\n```\n:::\n\n\n-   se puede agregar mas niveles de agrupamiento\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-26_d78f9e48954b8ac0435279ae69489240'}\n\n```{.r .cell-code}\nbce_met1 %>% \n  count(mes, helada_meteo)\n```\n:::\n\n\n### summarise()\n\nReduce múltiples valores a valores resúmenes. Generalmente combinado con `group_by()`\n\n> para cada mes: cuantos dias helaron y cual fue la temp media\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-27_dc7f1ea5af4581a287ac5958276fafb1'}\n\n```{.r .cell-code}\nbce_met1 %>% \n  group_by(mes) %>% \n  summarise(\n    tmedia=mean(tmedia), \n    n_helada_meteo=sum(helada_meteo),\n    n_helada_agro=sum(helada_agro)\n  ) -> bce_sum\nbce_sum\n```\n:::\n\n\n### arrange()\n\nCambia el orden de las filas\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-28_f7f9db2e9eff06b04a08243cbec518ef'}\n\n```{.r .cell-code}\nbce_sum %>%\n  arrange(tmedia)\n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-29_c2367bc21b9a92b87c4298424c9ca667'}\n\n```{.r .cell-code}\nbce_sum %>%\n  arrange(-tmedia)\n```\n:::\n\n\nYa que hicimos tantas modificaciones a los datos es un buen momento para guardar en formato `.Rdata` o `.rda`\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-30_ba27a4c38af002525a8af43e8b94e8b3'}\n\n```{.r .cell-code}\n# save(bce_met_raw, bce_met1, bce_sum, file=\"data/meteo_bce.Rdata\")\nload(\"data/meteo_bce.Rdata\")\nls()\n```\n:::\n\n\n::: callout-note\n### Gráfico de Temperaturas media\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-31_921b732000c7a3072a0c317b63d7f83f'}\n\n```{.r .cell-code}\nbce_met1 %>% \n  ggplot() + \n  aes(x=fecha, y=tmedia)+\n  geom_line() +\n  labs(x=\"\", y=\"Temperatura media diaria (ºC)\") + \n  scale_x_date(date_breaks = \"1 month\", date_labels = \"%b\")+\n  theme(axis.text.x = element_text(angle=45, hjust = 1)) \n```\n:::\n\n\n### Gráfico de tmax, tmin, y tmean\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-32_37c463f5aa8b0a9d1cd39e2561e9b191'}\n\n```{.r .cell-code}\nbce_met %>% \n  ggplot() + \n  aes(x=fecha)+\n  # Agrego una variable por capa\n  geom_line(aes(y = tmean, col = \"Media\"), alpha=.5) +\n  geom_line(aes(y = tmax, col = \"Máxima\"), alpha=.5) +\n  geom_line(aes(y = tmin, col = \"Mínima\"), alpha=.5) +\n  # con ajuste manual de los colores\n  scale_colour_manual(\"Temperatura\",\n                      values = c(\"Media\" = \"black\", \n                                 \"Máxima\" = \"red\", \n                                 \"Mínima\" = \"blue\"))+ \n  theme_bw() + \n  \n  # nos interesa visualizar de junio a diciembre\n  scale_x_date(date_breaks = \"1 month\", date_labels = \"%b\",\n               limits = as.Date(c(\"2018-06-01\", \"2018-31-12\")))+\n  \n  # algunos ajustes finos\n  theme(axis.text.x = element_text(angle=45, hjust = 1))+\n  labs(y=\"°C\")\n```\n:::\n\n:::\n\n### join()\n\nNos acaban de pasar los datos de lluvias de Balcarce en 2018\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-33_4c8d98be8f7588767985608d4cc6809c'}\n\n```{.r .cell-code}\nbce_lluvias_raw <- rio::import(\"data/datos_curso.xls\", sheet =\"bce_lluvias\")\nbce_lluvias_raw\n```\n:::\n\n\nseria interesante poder acoplar a nuestro dataset `bce_met1`\n\nVeamos los datos meteorologicos de Balcarce:\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-34_16a423af3ccab1ae8dc56dc6e93ee4da'}\n\n```{.r .cell-code}\nbce_met1\nbce_lluvias_raw \n```\n:::\n\n\nQué columnas tenemos en comun??\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-35_a3a46d4ed4025fe33523ce1e0c3ab866'}\n\n```{.r .cell-code}\njanitor::compare_df_cols(bce_met1, bce_lluvias_raw)\n```\n:::\n\n\nSi hacemos la misma conversion fecha a date tendriamos una columna en comun\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-36_691d8f53ebd4334ecac773b06e10a566'}\n\n```{.r .cell-code}\nbce_lluvias <- bce_lluvias_raw %>% \n  mutate(fecha = dmy(fecha))  \njanitor::compare_df_cols(bce_met1, bce_lluvias)\n```\n:::\n\n\nAhora hagamos uso de `left_join()` para que matcheen las filas y se peguen la columna de lluvia a bce_met2\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-37_b5dcc80001a25eb7104978fe2346e9ba'}\n\n```{.r .cell-code}\nbce_full <- bce_met1 %>% left_join(bce_lluvias, by=\"fecha\") \nbce_full\n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-38_8b11dc31248e6001efe90eea598132be'}\n\n```{.r .cell-code}\nbce_full %>% \n  ggplot() + \n  aes(x=fecha)+\n  geom_col(aes(y = pp), col=\"blue\") + \n  geom_line(aes(y=tmedia), col=\"green\") + \n  theme_bw() + \n  scale_x_date(date_breaks = \"1 month\", date_labels = \"%b\",\n               limits = as.Date(c(\"2018-06-01\", \"2018-31-12\")))+\n  theme(axis.text.x = element_text(angle=45, hjust = 1))\n```\n:::\n\n\n## [{forcats}](https://github.com/rstudio/cheatsheets/blob/main/factors.pdf)\n\nEl paquete `{forcats}` hace un aporte clave para la manipulación de los niveles de un factor. Retomemos un ejemplo de tipico de visualización con `iris`\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-39_26a899559c34e10ed96f70fa96c6beeb'}\n\n```{.r .cell-code}\niris %>%\n  ggplot() +\n  aes(x=Species, y=Sepal.Length)+\n  geom_boxplot(fill=\"gray90\")+\n  geom_jitter()+\n  labs(x= \"Species\", y=\"Sepal length (cm)\") + \n  theme_bw()\n```\n:::\n\n\n> Reordenar niveles de un factor\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-40_d9b0a4565a22de4b85925469adc5e905'}\n\n```{.r .cell-code}\niris %>% \n  mutate(\n    Species = fct_relevel(Species,\"virginica\")\n    ) %>% \n  ggplot() +\n  aes(x=Species, y=Sepal.Length)+\n  geom_boxplot(fill=\"gray90\")+\n  geom_jitter()+\n  labs(x= \"Species\", y=\"Sepal length (cm)\") + \n  theme_bw()\n```\n:::\n\n\n> Renombrar niveles de un factor\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-41_f069bdc70bc6a27c378be948489e9a1a'}\n\n```{.r .cell-code}\niris %>%\n  mutate(\n    Species= fct_recode(Species,\n                        \"Setosa\"=\"setosa\", \n                        \"Versicolor\"=\"versicolor\", \n                        \"Virginica\"=\"virginica\")\n    ) %>%\n  ggplot() +\n  aes(x=Species, y=Sepal.Length)+\n  geom_boxplot(fill=\"gray90\")+\n  geom_jitter()+\n  labs(x= \"Species\", y=\"Sepal length (cm)\") + \n  theme_bw()\n```\n:::\n\n\n## [{tidyr}](https://github.com/rstudio/cheatsheets/blob/main/tidyr.pdf)\n\nContiene funciones para re-estructurar dataframes. Similar al conocido \"transponer\" de excel.\n\n(fig/tidyr-pivot_wider_longer.gif)\n\n### pivot_longer()\n\nPor lo general en la etapa de toma de datos en el campo/lab (y su consiguiente pasaje a planilla electrónica, Excel) nos resulta más cómodo que las planillas de papel tengan un formato *wide*.\n\nEn muchas ocasiones necesitamos (para graficar o modelar) que nuestros datos estén en formato *long*.\n\nLa función `pivot_longer` apila las columnas que indiquemos, re-arregando los datos de un formato \"wide\" a \"long\":\n\nImportemos **soja**\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-42_1df47304c0ea85aba78d4d7a30b78df5'}\n\n```{.r .cell-code}\nsoja  <- rio::import(\"data/datos_curso.xls\", sheet =\"soja\")\nsoja\n```\n:::\n\n\nEn este caso necesitamos generar una columna `bk` y `yield`, o sea, tornar soja de \"wide\" a \"long\":\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-43_19b661aa958a0b6776d5d7d0e80ef1f6'}\n\n```{.r .cell-code}\nsoja %>% \n  pivot_longer(\n    cols=c(bk_1, bk_2, bk_3, bk_4), \n    names_to = \"bk\", \n    values_to = \"yield\") -> soja_long \nsoja_long \n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-44_31a9e807cb5a06838c57ee68fc753c9f'}\n\n```{.r .cell-code}\nsoja %>% \n  pivot_longer(\n    cols=contains(\"_\"),\n    names_to = \"bk\", \n    values_to = \"yield\", \n    names_prefix = \"bk_\") %>% \n  mutate_if(is.character, as.factor)-> soja_long\n\nsoja_long\n```\n:::\n\n\n::: callout-note\n### pivot_longer 2\n\n- Medidas repetidas en el tiempo\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-45_62824e1788245f3c8a8cbe5817e3c8fb'}\n\n```{.r .cell-code}\ncanola  <- rio::import(\"data/datos_curso.xls\", sheet =\"canola\")\ncanola\n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-46_fb904c06e28e46c618f463b1a5e03197'}\n\n```{.r .cell-code}\ncanola %>%  \n  pivot_longer(\n    cols=contains(\"_\"),\n    names_to = \"tt\",\n    values_to = \"inc\", \n    names_prefix = \"inc_\")-> can_long\ncan_long\n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-47_18ba2851e4c17c2852f2438337b927ca'}\n\n```{.r .cell-code}\ncan_long %>% \n  mutate_at(\"tt\", as.numeric) %>% \n  ggplot()+\n  aes(x=tt, y=inc, group=1)+\n  geom_line() + \n  geom_point()+\n  facet_grid(bk ~ trt)\n```\n:::\n\n\n## unite()\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-48_80b5b87529082dba289aacf03b74be2d'}\n\n```{.r .cell-code}\ncan_long %>% \n  unite(col=\"par\", bk, trt, sep = \"_\", remove = FALSE) -> can_long2\ncan_long2\n\ncan_long2 %>% \n  mutate_at(\"tt\", as.numeric) %>% \n  ggplot()+\n  aes(x=tt, y=inc, group=1)+\n  geom_line() + \n  facet_wrap(\"par\")\n```\n:::\n\n\n::: \n\n::: callout-note\n### pivot_longer 3\n\nSupongamos que queremos graficar multiples variables en un mismo grafico pero en diferentes paneles (\"facets\")\n\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-49_bda8b7700b2abbf97e30f18d4c091e19'}\n\n```{.r .cell-code}\nbce_full %>% \n  ungroup() %>% \n  select(fecha, tmedia, rad) %>% \n  pivot_longer(cols = -fecha, \n               names_to = \"var\", \n               values_to = \"val\") -> bce_full_long \nbce_full_long \n```\n:::\n\n::: {.cell hash='7-manipular_cache/html/unnamed-chunk-50_704dd7e8baa44dd452e8d587ac9a7047'}\n\n```{.r .cell-code}\nbce_full_long %>% \n  ggplot() + \n  aes(x = fecha, y = val, col=var) +  \n  geom_line() + \n  facet_grid(var~., scales = \"free\") + \n  scale_x_date(date_breaks = \"1 month\", date_labels = \"%b\")+ \n  theme(axis.text.x = element_text(angle=45, hjust = 1))  + \n  labs(x=\"\", y=\"\") + \n  guides(col=\"none\")\n```\n:::\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}